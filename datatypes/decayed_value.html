<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>Algebird</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Abstract Algebra for Scala." /><meta name="author" content="Algebird's contributors" /><meta name="og:image" content="/algebird/img/poster.png" /><meta name="og:title" content="Algebird" /><meta name="og:site_name" content="Algebird" /><meta name="og:url" content="http://twitter.github.io/algebird" /><meta name="og:type" content="website" /><meta name="og:description" content="Abstract Algebra for Scala." /><meta name="twitter:image" content="/algebird/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><link rel="icon" type="image/png" href="/algebird/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/algebird/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/algebird/css/style.css" /><link rel="stylesheet" href="/algebird/css/palette.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/algebird/" class="brand"><div class="brand-wrapper" style="background:url('/algebird/img/sidebar_brand.png') no-repeat"><span>Algebird</span></div></a></li> <li><a href="/algebird/datatypes.html" class="">Data Types</a></li> <li><a href="/algebird/datatypes/combinator.html" class="">Combinators</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/combinator/collections.html" class="">Scala Collections</a></li> <li><a href="/algebird/datatypes/combinator/java_collections.html" class="">Java Collections</a></li> <li><a href="/algebird/datatypes/combinator/option_monoid.html" class="">Option Monoid</a></li> <li><a href="/algebird/datatypes/combinator/caseclass.html" class="">Case Class Algebra</a></li> <li><a href="/algebird/datatypes/combinator/cuber.html" class="">Cuber</a></li> <li><a href="/algebird/datatypes/combinator/roller.html" class="">Roller</a></li> <li><a href="/algebird/datatypes/combinator/eventually.html" class="">Eventually</a></li> <li><a href="/algebird/datatypes/combinator/priority.html" class="">Priority</a></li> <li><a href="/algebird/datatypes/combinator/product_algebra.html" class="">Product/Tuple Algebra</a></li> <li><a href="/algebird/datatypes/combinator/monoid_statistics.html" class="">Monoid Statistics</a></li></ul></li> <li><a href="/algebird/datatypes/approx.html" class="">Approximate Data Types</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/approx/approximate.html" class="">Approximate</a></li> <li><a href="/algebird/datatypes/approx/bloom_filter.html" class="">Bloom Filter</a></li> <li><a href="/algebird/datatypes/approx/countminsketch.html" class="">Count Min Sketch</a></li> <li><a href="/algebird/datatypes/approx/exponential_histogram.html" class="">Exponential Histogram</a></li> <li><a href="/algebird/datatypes/approx/hyperloglog.html" class="">HyperLogLog</a></li> <li><a href="/algebird/datatypes/approx/hyperloglog_series.html" class="">HyperLogLog Series</a></li> <li><a href="/algebird/datatypes/approx/min_hasher.html" class="">MinHasher</a></li> <li><a href="/algebird/datatypes/approx/q_tree.html" class="">Q Tree</a></li> <li><a href="/algebird/datatypes/approx/space_saver.html" class="">SpaceSaver</a></li></ul></li> <li><a href="/algebird/datatypes/summer.html" class="">Summers</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/summer/adaptive_cache.html" class="">AdaptiveCache</a></li> <li><a href="/algebird/datatypes/summer/batched.html" class="">Batched</a></li> <li><a href="/algebird/datatypes/summer/sum_all.html" class="">SumAll</a></li> <li><a href="/algebird/datatypes/summer/summingcache.html" class="">SummingCache</a></li> <li><a href="/algebird/datatypes/summer/summingiterator.html" class="">SummingIterator</a></li> <li><a href="/algebird/datatypes/summer/summingqueue.html" class="">SummingQueue</a></li></ul></li> <li><a href="/algebird/datatypes/min_and_max.html" class="">Ordered Semigroups</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/first_and_last.html" class="">First and Last</a></li> <li><a href="/algebird/datatypes/min_and_max.html" class="">Min and Max</a></li></ul></li> <li><a href="/algebird/datatypes/adaptive_matrix.html" class="">Adaptive Matrix</a></li> <li><a href="/algebird/datatypes/adaptive_vector.html" class="">Adaptive Vector</a></li> <li><a href="/algebird/datatypes/affine_function.html" class="">Affine Function</a></li> <li><a href="/algebird/datatypes/averaged_value.html" class="">Averaged Value</a></li> <li><a href="/algebird/datatypes/bytes.html" class="">Bytes</a></li> <li><a href="/algebird/datatypes/decayed_value.html" class=" active ">Decayed Value</a></li> <li><a href="/algebird/datatypes/decayed_vector.html" class="">Decayed Vector</a></li> <li><a href="/algebird/datatypes/five_moments.html" class="">First Five Moments</a></li> <li><a href="/algebird/datatypes/gaussian_distribution.html" class="">Gaussian Distribution</a></li> <li><a href="/algebird/datatypes/interval.html" class="">Interval</a></li> <li><a href="/algebird/datatypes/min_plus_algebra.html" class="">Min Plus Algebra</a></li> <li><a href="/algebird/datatypes/reset_state.html" class="">ResetState</a></li> <li><a href="/algebird/datatypes/right_folded.html" class="">RightFolded</a></li> <li><a href="/algebird/datatypes/set_diff.html" class="">SetDiff</a></li> <li><a href="/algebird/datatypes/sgd.html" class="">Stochastic Gradient Descent</a></li> <li><a href="/algebird/datatypes/topk.html" class="">TopK</a></li>         </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="hidden-xs"><a href="https://github.com/twitter/algebird"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li class="hidden-xs"><a href="https://github.com/twitter/algebird"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Algebird Abstract Algebra for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Algebird Abstract Algebra for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="twitter" data-github-repo="algebird"><div class="content-wrapper"><section><h1 id="decayed-value-aka-moving-average">Decayed Value (aka. moving average)</h1>

<p>A <code class="highlighter-rouge">DecayedValue</code> can be approximately computed into a moving average. Please see an explanation of different averages here: <a href="http://donlehmanjr.com/Science/03%20Decay%20Ave/032.htm">The Decaying Average</a>.</p>

<p><a href="https://www.github.com/johnynek">@johnynek</a> mentioned that:</p>

<blockquote>
  <p>a DecayedValue is approximately like a moving average value with window size of the half-life. It is EXACTLY a sample of the Laplace transform of the signal of values. Therefore, if we normalize a decayed value with halflife/ln(2), which is the integral of exp(-t(ln(2))/halflife) from 0 to infinity. We get a moving average of the window size equal to halflife.</p>
</blockquote>

<p>See the related issue: https://github.com/twitter/algebird/issues/235</p>

<p>Here is the code example for computing a <code class="highlighter-rouge">DecayedValue</code> average:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.twitter.algebird._</span>
<span class="c1">// import com.twitter.algebird._
</span>
<span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">rnd</span> <span class="k">=</span> <span class="k">new</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span>
  <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">10</span><span class="o">).</span><span class="n">map</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">rnd</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="mi">1000</span><span class="o">).</span><span class="n">toDouble</span> <span class="o">}.</span><span class="n">toSeq</span>
<span class="o">}</span>
<span class="c1">// data: scala.collection.immutable.Seq[Double] = Vector(855.0, 403.0, 326.0, 331.0, 657.0, 299.0, 811.0, 361.0, 463.0, 358.0)
</span>
<span class="k">val</span> <span class="nc">HalfLife</span> <span class="k">=</span> <span class="mf">5.0</span>
<span class="c1">// HalfLife: Double = 5.0
</span>
<span class="k">val</span> <span class="n">normalization</span> <span class="k">=</span> <span class="nc">HalfLife</span> <span class="o">/</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
<span class="c1">// normalization: Double = 7.213475204444817
</span>
<span class="k">implicit</span> <span class="k">val</span> <span class="n">dvMonoid</span> <span class="k">=</span> <span class="nc">DecayedValue</span><span class="o">.</span><span class="n">monoidWithEpsilon</span><span class="o">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span><span class="o">)</span>
<span class="c1">// dvMonoid: com.twitter.algebird.Monoid[com.twitter.algebird.DecayedValue] = DecayedValueMonoid(0.001)
</span>
<span class="n">data</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="o">.</span><span class="n">scanLeft</span><span class="o">(</span><span class="nc">Monoid</span><span class="o">.</span><span class="n">zero</span><span class="o">[</span><span class="kt">DecayedValue</span><span class="o">])</span> <span class="o">{</span> <span class="o">(</span><span class="n">previous</span><span class="o">,</span> <span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">time</span><span class="o">)</span> <span class="k">=</span> <span class="n">data</span>
  <span class="k">val</span> <span class="n">decayed</span> <span class="k">=</span> <span class="nc">Monoid</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="n">previous</span><span class="o">,</span> <span class="nc">DecayedValue</span><span class="o">.</span><span class="n">build</span><span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">time</span><span class="o">,</span> <span class="nc">HalfLife</span><span class="o">))</span>
  <span class="n">println</span><span class="o">(</span><span class="s">"At %d: decayed=%f"</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="o">(</span><span class="n">decayed</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">normalization</span><span class="o">)))</span>
  <span class="n">decayed</span>
<span class="o">}</span>
<span class="c1">// At 0: decayed=118.528168
// At 1: decayed=159.052426
// At 2: decayed=183.656375
// At 3: decayed=205.768504
// At 4: decayed=270.211427
// At 5: decayed=276.682911
// At 6: decayed=353.294937
// At 7: decayed=357.606333
// At 8: decayed=375.499823
// At 9: decayed=376.520921
// res0: scala.collection.immutable.Seq[com.twitter.algebird.DecayedValue] = Vector(DecayedValue(0.0,-Infinity), DecayedValue(855.0,0.0), DecayedValue(1147.320731618186,0.13862943611198905), DecayedValue(1324.800709191533,0.2772588722239781), DecayedValue(1484.306003641794,0.4158883083359671), DecayedValue(1949.1634275741826,0.5545177444479562), DecayedValue(1995.8453198309087,0.6931471805599453), DecayedValue(2548.484267430731,0.8317766166719343), DecayedValue(2579.584414563133,0.9704060527839233), DecayedValue(2708.658665167838,1.1090354888959124), DecayedValue(2716.024326738789,1.2476649250079015))
</span></code></pre>
</div>

<p>Running the above code in comparison with a simple decayed average:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="o">.</span><span class="n">scanLeft</span><span class="o">(</span><span class="mf">0.0</span><span class="o">)</span> <span class="o">{</span> <span class="o">(</span><span class="n">previous</span><span class="o">,</span> <span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span>
  <span class="k">val</span> <span class="o">(</span><span class="n">value</span><span class="o">,</span> <span class="n">time</span><span class="o">)</span> <span class="k">=</span> <span class="n">data</span>
  <span class="k">val</span> <span class="n">avg</span> <span class="k">=</span> <span class="o">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">previous</span> <span class="o">*</span> <span class="o">(</span><span class="nc">HalfLife</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">))</span> <span class="o">/</span> <span class="nc">HalfLife</span>
  <span class="n">println</span><span class="o">(</span><span class="s">"At %d: windowed=%f"</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">avg</span><span class="o">))</span>
  <span class="n">avg</span>
<span class="o">}</span>
<span class="c1">// At 0: windowed=171.000000
// At 1: windowed=217.400000
// At 2: windowed=239.120000
// At 3: windowed=257.496000
// At 4: windowed=337.396800
// At 5: windowed=329.717440
// At 6: windowed=425.973952
// At 7: windowed=412.979162
// At 8: windowed=422.983329
// At 9: windowed=409.986663
// res1: scala.collection.immutable.Seq[Double] = Vector(0.0, 171.0, 217.4, 239.11999999999998, 257.496, 337.3968, 329.71744, 425.973952, 412.97916160000005, 422.98332928, 409.986663424)
</span></code></pre>
</div>

<p>You’ll see that the averages are pretty close to each other.</p>

<h2 id="decayedvalue-faq">DecayedValue FAQ</h2>

<h3 id="is-a-decayedvalue-average-better-than-a-moving-average">Is a DecayedValue average better than a moving average?</h3>

<p>DecayedValue gives an exponential moving average. A standard windowed moving average of <code class="highlighter-rouge">N</code> points requires <code class="highlighter-rouge">O(N)</code> memory. An exponential moving average takes <code class="highlighter-rouge">O(1)</code> memory. That’s the win. Usually one, or a few, exponential moving averages gives you what you need cheaper than the naive approach of keeping 100 or 1000 recent points.</p>

<h3 id="is-a-decayedvalue-average-better-than-a-simple-decayed-average">Is a DecayedValue average better than a simple decayed average?</h3>

<p>A simple decayed average looks like this:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="n">avg</span> <span class="k">=</span> <span class="o">(</span><span class="n">value</span> <span class="o">+</span> <span class="n">previousAvg</span> <span class="o">*</span> <span class="o">(</span><span class="nc">HaflLife</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">))</span> <span class="o">/</span> <span class="nc">HalfLife</span>
</code></pre>
</div>

<p>In a way, a <code class="highlighter-rouge">DecayedValue</code> average is a simple decayed average with different scaling factor.</p>

<h3 id="documentation-help">Documentation Help</h3>

<p>We’d love your help fleshing out this documentation! You can edit this page in your browser by clicking <a href="https://github.com/twitter/algebird/edit/develop/docs/src/main/tut/datatypes/decayed_value.md">this link</a>. These links might be helpful:</p>

<ul>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/DecayedValue.scala">DecayedValue.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-test/src/test/scala/com/twitter/algebird/DecayedValueTest.scala">DecayedValueTest.scala</a></li>
</ul>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/algebird/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/algebird/js/main.js"></script></body></html>