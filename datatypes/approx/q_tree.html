<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>Algebird</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Abstract Algebra for Scala." /><meta name="author" content="Algebird's contributors" /><meta name="og:image" content="/algebird/img/poster.png" /><meta name="og:title" content="Algebird" /><meta name="og:site_name" content="Algebird" /><meta name="og:url" content="http://twitter.github.io/algebird" /><meta name="og:type" content="website" /><meta name="og:description" content="Abstract Algebra for Scala." /><meta name="twitter:image" content="/algebird/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><link rel="icon" type="image/png" href="/algebird/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/algebird/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/algebird/css/style.css" /><link rel="stylesheet" href="/algebird/css/palette.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/algebird/" class="brand"><div class="brand-wrapper" style="background:url('/algebird/img/sidebar_brand.png') no-repeat"><span>Algebird</span></div></a></li> <li><a href="/algebird/datatypes.html" class="">Data Types</a></li> <li><a href="/algebird/datatypes/approx.html" class="">Approximate Data Types</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/approx/approximate.html" class="">Approximate</a></li> <li><a href="/algebird/datatypes/approx/bloom_filter.html" class="">Bloom Filter</a></li> <li><a href="/algebird/datatypes/approx/countminsketch.html" class="">Count Min Sketch</a></li> <li><a href="/algebird/datatypes/approx/exponential_histogram.html" class="">Exponential Histogram</a></li> <li><a href="/algebird/datatypes/approx/hyperloglog.html" class="">HyperLogLog</a></li> <li><a href="/algebird/datatypes/approx/hyperloglog_series.html" class="">HyperLogLog Series</a></li> <li><a href="/algebird/datatypes/approx/min_hasher.html" class="">MinHasher</a></li> <li><a href="/algebird/datatypes/approx/q_tree.html" class=" active ">Q Tree</a></li> <li><a href="/algebird/datatypes/approx/space_saver.html" class="">SpaceSaver</a></li></ul></li> <li><a href="/algebird/datatypes/combinator.html" class="">Combinators</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/combinator/collections.html" class="">Scala Collections</a></li> <li><a href="/algebird/datatypes/combinator/java_collections.html" class="">Java Collections</a></li> <li><a href="/algebird/datatypes/combinator/option_monoid.html" class="">Option Monoid</a></li> <li><a href="/algebird/datatypes/combinator/caseclass.html" class="">Case Class Algebra</a></li> <li><a href="/algebird/datatypes/combinator/cuber.html" class="">Cuber</a></li> <li><a href="/algebird/datatypes/combinator/roller.html" class="">Roller</a></li> <li><a href="/algebird/datatypes/combinator/eventually.html" class="">Eventually</a></li> <li><a href="/algebird/datatypes/combinator/priority.html" class="">Priority</a></li> <li><a href="/algebird/datatypes/combinator/product_algebra.html" class="">Product/Tuple Algebra</a></li> <li><a href="/algebird/datatypes/combinator/monoid_statistics.html" class="">Monoid Statistics</a></li></ul></li> <li><a href="/algebird/datatypes/summer.html" class="">Summers</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/summer/adaptive_cache.html" class="">AdaptiveCache</a></li> <li><a href="/algebird/datatypes/summer/batched.html" class="">Batched</a></li> <li><a href="/algebird/datatypes/summer/sum_all.html" class="">SumAll</a></li> <li><a href="/algebird/datatypes/summer/summingcache.html" class="">SummingCache</a></li> <li><a href="/algebird/datatypes/summer/summingiterator.html" class="">SummingIterator</a></li> <li><a href="/algebird/datatypes/summer/summingqueue.html" class="">SummingQueue</a></li></ul></li> <li><a href="/algebird/datatypes/min_and_max.html" class="">Ordered Semigroups</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/min_and_max.html" class="">Min and Max</a></li> <li><a href="/algebird/datatypes/first_and_last.html" class="">First and Last</a></li></ul></li> <li><a href="/algebird/datatypes/adaptive_matrix.html" class="">Adaptive Matrix</a></li> <li><a href="/algebird/datatypes/adaptive_vector.html" class="">Adaptive Vector</a></li> <li><a href="/algebird/datatypes/affine_function.html" class="">Affine Function</a></li> <li><a href="/algebird/datatypes/averaged_value.html" class="">Averaged Value</a></li> <li><a href="/algebird/datatypes/bytes.html" class="">Bytes</a></li> <li><a href="/algebird/datatypes/decayed_value.html" class="">Decayed Value</a></li> <li><a href="/algebird/datatypes/decayed_vector.html" class="">Decayed Vector</a></li> <li><a href="/algebird/datatypes/five_moments.html" class="">First Five Moments</a></li> <li><a href="/algebird/datatypes/gaussian_distribution.html" class="">Gaussian Distribution</a></li> <li><a href="/algebird/datatypes/interval.html" class="">Interval</a></li> <li><a href="/algebird/datatypes/min_plus_algebra.html" class="">Min Plus Algebra</a></li> <li><a href="/algebird/datatypes/reset_state.html" class="">ResetState</a></li> <li><a href="/algebird/datatypes/right_folded.html" class="">RightFolded</a></li> <li><a href="/algebird/datatypes/set_diff.html" class="">SetDiff</a></li> <li><a href="/algebird/datatypes/sgd.html" class="">Stochastic Gradient Descent</a></li> <li><a href="/algebird/datatypes/topk.html" class="">TopK</a></li>        </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="hidden-xs"><a href="https://github.com/sritchie/algebird"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li class="hidden-xs"><a href="https://github.com/sritchie/algebird"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Algebird Abstract Algebra for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Algebird Abstract Algebra for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="sritchie" data-github-repo="algebird"><div class="content-wrapper"><section><h1 id="q-tree">Q Tree</h1>

<p>A <code class="highlighter-rouge">QTree[A: Monoid]</code> is like an approximate <code class="highlighter-rouge">Map[Double, A: Monoid]</code> that can store only a fixed number of keys. Instead of storing key-value pairs, it stores range-value pairs, where each range is a small Double interval, and the ranges don’t overlap. When there are too many keys, it combines nearby range-value pairs, combining the ranges, and combining the values using the <code class="highlighter-rouge">Monoid[A]</code> operation. Each range-value pair also keeps track of its count, i.e. the number of key-value pairs the range is composed of.</p>

<p>For example, suppose we create a QTree[String] from the following values: (remember that <code class="highlighter-rouge">String</code> is a <code class="highlighter-rouge">Monoid</code> under concatenation)</p>

<ul>
  <li>0.1, “he”</li>
  <li>0.2, “ll”</li>
  <li>0.21, “o”</li>
  <li>0.26, “wo”</li>
  <li>0.3, “r”</li>
  <li>0.4, “l”</li>
  <li>0.49, “d”</li>
</ul>

<p>This QTree might be represented as</p>

<ul>
  <li>[0,0.125), “he”, count=1</li>
  <li>[0.125,0.25), “llo”, count=2</li>
  <li>[0.25, 0.375), “wor”, count=2</li>
  <li>[0.375, 0.5), “ld”, count=2</li>
</ul>

<p>or as</p>

<ul>
  <li>[0, 0.25), “hello”, count=3</li>
  <li>[0.25, 0.5), “world”, count=4</li>
</ul>

<p>or as</p>

<ul>
  <li>[0,0.5), “helloworld”, count=7</li>
</ul>

<p>How is this useful?</p>

<p>The most common usage of <code class="highlighter-rouge">QTree</code> is as <code class="highlighter-rouge">QTree[Unit]</code>. (Remember, <code class="highlighter-rouge">Unit</code> is a trivial monoid, where <code class="highlighter-rouge">() + () = ()</code> and <code class="highlighter-rouge">()</code> is the identity.)</p>

<p>This is basically a histogram. Why? When two ranges get combined, the counts get added together, so at any point, the count associated with a range R is exactly the number of original Double values in that range.</p>
<ul>
  <li>The <code class="highlighter-rouge">quantileBounds</code> function gives lower and upper bounds for a given quantile.
For instance, <code class="highlighter-rouge">qtree.quantileBounds(0.5)</code> gives bounds for the median double value.</li>
  <li>The <code class="highlighter-rouge">rangeCountBounds</code> function gives lower and upper bounds for the count within a certain range.
For instance, <code class="highlighter-rouge">qtree.rangeCountBounds(0.5, 2.5)</code> gives lower and upper bounds for the number of elements in the range (0.5, 2.5).</li>
</ul>

<p>What happens if we use a nontrivial monoid <code class="highlighter-rouge">A</code>, instead of <code class="highlighter-rouge">Unit</code>? Then we get some more useful functions:</p>
<ul>
  <li><code class="highlighter-rouge">rangeSumBounds</code> gives lower and upper bounds for the monoid sum of the elements in a certain range.</li>
</ul>

<p>For example, if we call <code class="highlighter-rouge">qtree.rangeSumBounds(0.1,0.2)</code> on the first QTree described above, it would return <code class="highlighter-rouge">("","hello")</code>. Why is it a range, and not an exact value? This is because we only store the ranges and we don’t know exactly where in the range each item is. For example, <code class="highlighter-rouge">"he"</code> might exist between 0 and 0.09999 and <code class="highlighter-rouge">"llo"</code> might exist between 0.20001 and 0.25, in which case the true sum over (0.1,0.2) would be <code class="highlighter-rouge">""</code>. On the other hand, <code class="highlighter-rouge">"he"</code> might exist between 0.1 and 0.125, and <code class="highlighter-rouge">"llo"</code> might exist between 0.125 and 0.2, in which case the true sum would be <code class="highlighter-rouge">"hello"</code>. The answer could also be anywhere in between these two results. If we look at the original data points, we see that the correct answer is actually <code class="highlighter-rouge">"he"</code>, since <code class="highlighter-rouge">"he"</code> is the only value in the range [0.1,0.2).</p>

<ul>
  <li><code class="highlighter-rouge">totalSum</code> returns the total sum over the entire tree. In the example above, <code class="highlighter-rouge">qtree.totalSum</code> would return <code class="highlighter-rouge">"helloworld"</code>.</li>
</ul>

<h3 id="repl-tour">REPL Tour</h3>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.twitter.algebird._</span>
<span class="c1">// import com.twitter.algebird._
</span>
<span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">8</span><span class="o">)</span>
<span class="c1">// data: List[Int] = List(1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 8)
</span>
<span class="k">val</span> <span class="n">seqQTree</span> <span class="k">=</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="nc">QTree</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">}</span>
<span class="c1">// seqQTree: List[com.twitter.algebird.QTree[Long]] = List((1,0,1,1,None,None), (1,0,1,1,None,None), (2,0,1,2,None,None), (2,0,1,2,None,None), (3,0,1,3,None,None), (3,0,1,3,None,None), (4,0,1,4,None,None), (4,0,1,4,None,None), (5,0,1,5,None,None), (5,0,1,5,None,None), (6,0,1,6,None,None), (6,0,1,6,None,None), (7,0,1,7,None,None), (7,0,1,7,None,None), (8,0,1,8,None,None), (8,0,1,8,None,None))
</span>
<span class="k">val</span> <span class="n">qtSemigroup</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">QTreeSemigroup</span><span class="o">[</span><span class="kt">Long</span><span class="o">](</span><span class="mi">6</span><span class="o">)</span>
<span class="c1">// qtSemigroup: com.twitter.algebird.QTreeSemigroup[Long] = com.twitter.algebird.QTreeSemigroup@2774d033
</span>
<span class="k">val</span> <span class="n">sum</span> <span class="k">=</span> <span class="n">qtSemigroup</span><span class="o">.</span><span class="n">sumOption</span><span class="o">(</span><span class="n">seqQTree</span><span class="o">).</span><span class="n">get</span>
<span class="c1">// sum: com.twitter.algebird.QTree[Long] = (0,4,16,0,Some((0,3,14,0,Some((0,2,6,0,Some((0,1,2,0,None,Some((1,0,2,2,None,None)))),Some((1,1,4,0,Some((2,0,2,4,None,None)),Some((3,0,2,6,None,None)))))),Some((1,2,8,0,Some((2,1,4,0,Some((4,0,2,8,None,None)),Some((5,0,2,10,None,None)))),Some((3,1,4,0,Some((6,0,2,12,None,None)),Some((7,0,2,14,None,None)))))))),Some((1,3,2,0,Some((2,2,2,0,Some((4,1,2,0,Some((8,0,2,16,None,None)),None)),None)),None)))
</span>
<span class="k">val</span> <span class="n">sum2</span> <span class="k">=</span> <span class="n">seqQTree</span><span class="o">.</span><span class="n">reduce</span><span class="o">{</span><span class="n">qtSemigroup</span><span class="o">.</span><span class="n">plus</span><span class="o">(</span><span class="k">_</span><span class="o">,</span><span class="k">_</span><span class="o">)}</span>
<span class="c1">// sum2: com.twitter.algebird.QTree[Long] = (0,4,16,0,Some((0,3,14,0,Some((0,2,6,0,Some((0,1,2,0,None,Some((1,0,2,2,None,None)))),Some((1,1,4,0,Some((2,0,2,4,None,None)),Some((3,0,2,6,None,None)))))),Some((1,2,8,0,Some((2,1,4,0,Some((4,0,2,8,None,None)),Some((5,0,2,10,None,None)))),Some((3,1,4,0,Some((6,0,2,12,None,None)),Some((7,0,2,14,None,None)))))))),Some((1,3,2,0,Some((2,2,2,0,Some((4,1,2,0,Some((8,0,2,16,None,None)),None)),None)),None)))
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">count</span>
<span class="c1">// warning: there was one inliner warning; re-run with -Yinline-warnings for details
// res0: Long = 16
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">upperBound</span>
<span class="c1">// res1: Double = 16.0
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">lowerBound</span>
<span class="c1">// res2: Double = 0.0
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">quantileBounds</span><span class="o">(.</span><span class="mi">5</span><span class="o">)</span>
<span class="c1">// res3: (Double, Double) = (5.0,6.0)
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">quantileBounds</span><span class="o">(.</span><span class="mi">5</span><span class="o">)</span>
<span class="c1">// res4: (Double, Double) = (5.0,6.0)
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">quantileBounds</span><span class="o">(.</span><span class="mi">25</span><span class="o">)</span>
<span class="c1">// res5: (Double, Double) = (3.0,4.0)
</span>
<span class="n">sum</span><span class="o">.</span><span class="n">quantileBounds</span><span class="o">(.</span><span class="mi">75</span><span class="o">)</span>
<span class="c1">// res6: (Double, Double) = (7.0,8.0)
</span></code></pre>
</div>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/algebird/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/algebird/js/main.js"></script></body></html>