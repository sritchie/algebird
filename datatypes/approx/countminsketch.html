<html><head><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><title>Algebird</title><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="description" content="Abstract Algebra for Scala." /><meta name="author" content="Algebird's contributors" /><meta name="og:image" content="/algebird/img/poster.png" /><meta name="og:title" content="Algebird" /><meta name="og:site_name" content="Algebird" /><meta name="og:url" content="http://twitter.github.io/algebird" /><meta name="og:type" content="website" /><meta name="og:description" content="Abstract Algebra for Scala." /><meta name="twitter:image" content="/algebird/img/poster.png" /><meta name="twitter:card" content="summary_large_image" /><meta name="twitter:site" content="" /><link rel="icon" type="image/png" href="/algebird/img/favicon.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/algebird/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/algebird/css/style.css" /><link rel="stylesheet" href="/algebird/css/palette.css" /></head><body class="docs"><div id="wrapper"><div id="sidebar-wrapper"><ul id="sidebar" class="sidebar-nav"><li class="sidebar-brand"><a href="/algebird/" class="brand"><div class="brand-wrapper" style="background:url('/algebird/img/sidebar_brand.png') no-repeat"><span>Algebird</span></div></a></li> <li><a href="/algebird/datatypes.html" class="">Data Types</a></li> <li><a href="/algebird/datatypes/combinator.html" class="">Combinators</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/combinator/collections.html" class="">Scala Collections</a></li> <li><a href="/algebird/datatypes/combinator/java_collections.html" class="">Java Collections</a></li> <li><a href="/algebird/datatypes/combinator/option_monoid.html" class="">Option Monoid</a></li> <li><a href="/algebird/datatypes/combinator/caseclass.html" class="">Case Class Algebra</a></li> <li><a href="/algebird/datatypes/combinator/cuber.html" class="">Cuber</a></li> <li><a href="/algebird/datatypes/combinator/roller.html" class="">Roller</a></li> <li><a href="/algebird/datatypes/combinator/eventually.html" class="">Eventually</a></li> <li><a href="/algebird/datatypes/combinator/priority.html" class="">Priority</a></li> <li><a href="/algebird/datatypes/combinator/product_algebra.html" class="">Product/Tuple Algebra</a></li> <li><a href="/algebird/datatypes/combinator/monoid_statistics.html" class="">Monoid Statistics</a></li></ul></li> <li><a href="/algebird/datatypes/approx.html" class="">Approximate Data Types</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/approx/approximate.html" class="">Approximate</a></li> <li><a href="/algebird/datatypes/approx/bloom_filter.html" class="">Bloom Filter</a></li> <li><a href="/algebird/datatypes/approx/countminsketch.html" class=" active ">Count Min Sketch</a></li> <li><a href="/algebird/datatypes/approx/exponential_histogram.html" class="">Exponential Histogram</a></li> <li><a href="/algebird/datatypes/approx/hyperloglog.html" class="">HyperLogLog</a></li> <li><a href="/algebird/datatypes/approx/hyperloglog_series.html" class="">HyperLogLog Series</a></li> <li><a href="/algebird/datatypes/approx/min_hasher.html" class="">MinHasher</a></li> <li><a href="/algebird/datatypes/approx/q_tree.html" class="">Q Tree</a></li> <li><a href="/algebird/datatypes/approx/space_saver.html" class="">SpaceSaver</a></li></ul></li> <li><a href="/algebird/datatypes/summer.html" class="">Summers</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/summer/adaptive_cache.html" class="">AdaptiveCache</a></li> <li><a href="/algebird/datatypes/summer/batched.html" class="">Batched</a></li> <li><a href="/algebird/datatypes/summer/sum_all.html" class="">SumAll</a></li> <li><a href="/algebird/datatypes/summer/summingcache.html" class="">SummingCache</a></li> <li><a href="/algebird/datatypes/summer/summingiterator.html" class="">SummingIterator</a></li> <li><a href="/algebird/datatypes/summer/summingqueue.html" class="">SummingQueue</a></li></ul></li> <li><a href="/algebird/datatypes/min_and_max.html" class="">Ordered Semigroups</a> <ul class="sub_section"> <li><a href="/algebird/datatypes/first_and_last.html" class="">First and Last</a></li> <li><a href="/algebird/datatypes/min_and_max.html" class="">Min and Max</a></li></ul></li> <li><a href="/algebird/datatypes/adaptive_matrix.html" class="">Adaptive Matrix</a></li> <li><a href="/algebird/datatypes/adaptive_vector.html" class="">Adaptive Vector</a></li> <li><a href="/algebird/datatypes/affine_function.html" class="">Affine Function</a></li> <li><a href="/algebird/datatypes/averaged_value.html" class="">Averaged Value</a></li> <li><a href="/algebird/datatypes/bytes.html" class="">Bytes</a></li> <li><a href="/algebird/datatypes/decayed_value.html" class="">Decayed Value</a></li> <li><a href="/algebird/datatypes/decayed_vector.html" class="">Decayed Vector</a></li> <li><a href="/algebird/datatypes/five_moments.html" class="">First Five Moments</a></li> <li><a href="/algebird/datatypes/gaussian_distribution.html" class="">Gaussian Distribution</a></li> <li><a href="/algebird/datatypes/interval.html" class="">Interval</a></li> <li><a href="/algebird/datatypes/min_plus_algebra.html" class="">Min Plus Algebra</a></li> <li><a href="/algebird/datatypes/reset_state.html" class="">ResetState</a></li> <li><a href="/algebird/datatypes/right_folded.html" class="">RightFolded</a></li> <li><a href="/algebird/datatypes/set_diff.html" class="">SetDiff</a></li> <li><a href="/algebird/datatypes/sgd.html" class="">Stochastic Gradient Descent</a></li> <li><a href="/algebird/datatypes/topk.html" class="">TopK</a></li>         </ul></div><div id="page-content-wrapper"><div class="nav"><div class="container-fluid"><div class="row"><div class="col-lg-12"><div class="action-menu pull-left clearfix"><a href="#menu-toggle" id="menu-toggle"><i class="fa fa-bars" aria-hidden="true"></i></a></div><ul class="pull-right"><li class="hidden-xs"><a href="https://github.com/twitter/algebird"><i class="fa fa-eye"></i><span>WATCH<span id="eyes" class="label label-default">--</span></span></a></li><li class="hidden-xs"><a href="https://github.com/twitter/algebird"><i class="fa fa-star-o"></i><span>STARS<span id="stars" class="label label-default">--</span></span></a></li><li><a href="#" onclick="shareSiteTwitter('Algebird Abstract Algebra for Scala.');"><i class="fa fa-twitter"></i></a></li><li><a href="#" onclick="shareSiteFacebook('Algebird Abstract Algebra for Scala.');"><i class="fa fa-facebook"></i></a></li><li><a href="#" onclick="shareSiteGoogle();"><i class="fa fa-google-plus"></i></a></li></ul></div></div></div></div><div id="content" data-github-owner="twitter" data-github-repo="algebird"><div class="content-wrapper"><section><h1 id="count-min-sketch">Count Min Sketch</h1>

<p>Count-min sketch is a probablistic data structure that estimates the frequencies of elements in a data stream. Count-min sketches are somewhat similar to Bloom filters; the main distinction is that Bloom filters represent sets, while count-min sketches represent multisets. For more info, see <a href="https://en.wikipedia.org/wiki/Count%E2%80%93min_sketch">Wikipedia</a>.</p>

<p>In Algebird, count-min sketches are represented as the abstract class <code class="highlighter-rouge">CMS</code>, along with the <code class="highlighter-rouge">CMSMonoid</code> class. Here’s an example usage:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.twitter.algebird._</span>
<span class="c1">// import com.twitter.algebird._
</span>
<span class="k">import</span> <span class="nn">CMSHasherImplicits._</span>
<span class="c1">// import CMSHasherImplicits._
</span>
<span class="k">val</span> <span class="nc">DELTA</span> <span class="k">=</span> <span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">10</span>
<span class="c1">// DELTA: Double = 1.0E-10
</span>
<span class="k">val</span> <span class="nc">EPS</span> <span class="k">=</span> <span class="mf">0.001</span>
<span class="c1">// EPS: Double = 0.001
</span>
<span class="k">val</span> <span class="nc">SEED</span> <span class="k">=</span> <span class="mi">1</span>
<span class="c1">// SEED: Int = 1
</span>
<span class="k">val</span> <span class="nc">HEAVY_HITTERS_PCT</span> <span class="k">=</span> <span class="mf">0.01</span>
<span class="c1">// HEAVY_HITTERS_PCT: Double = 0.01
</span>
<span class="k">val</span> <span class="nc">CMS_MONOID</span> <span class="k">=</span> <span class="nc">TopPctCMS</span><span class="o">.</span><span class="n">monoid</span><span class="o">[</span><span class="kt">Long</span><span class="o">](</span><span class="nc">EPS</span><span class="o">,</span> <span class="nc">DELTA</span><span class="o">,</span> <span class="nc">SEED</span><span class="o">,</span> <span class="nc">HEAVY_HITTERS_PCT</span><span class="o">)</span>
<span class="c1">// CMS_MONOID: com.twitter.algebird.TopPctCMSMonoid[Long] = com.twitter.algebird.TopPctCMSMonoid@266937ac
</span>
<span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">)</span>
<span class="c1">// data: List[Long] = List(1, 1, 3, 4, 5)
</span>
<span class="k">val</span> <span class="n">cms</span> <span class="k">=</span> <span class="nc">CMS_MONOID</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
<span class="c1">// cms: com.twitter.algebird.TopCMS[Long] = TopCMSInstance(SparseCMS(Map(1 -&gt; 2, 3 -&gt; 1, 4 -&gt; 1, 5 -&gt; 1),5,CMSParams(Vector(CMSHash(-1155869325,0,2719), CMSHash(431529176,0,2719), CMSHash(1761283695,0,2719), CMSHash(1749940626,0,2719), CMSHash(892128508,0,2719), CMSHash(155629808,0,2719), CMSHash(1429008869,0,2719), CMSHash(-1465154083,0,2719), CMSHash(-138487339,0,2719), CMSHash(-1242363800,0,2719), CMSHash(26273138,0,2719), CMSHash(655996946,0,2719), CMSHash(-155886662,0,2719), CMSHash(685382526,0,2719), CMSHash(-258276172,0,2719), CMSHash(-1915244828,0,2719), CMSHash(-226796111,0,2719), CMSHash(-382464772,0,2719), CMSHash(-270230103,0,2719), CMSHash(2092024379,0,2719), CMSHash(1705850753,0,2719), CMSHash(-369526632,0,2719), CMSHash(1492578621,0,2719), CMSHash(684358198,0,2719)),0.001,1....
</span>
<span class="n">cms</span><span class="o">.</span><span class="n">totalCount</span>
<span class="c1">// res0: Long = 5
</span>
<span class="n">cms</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="mi">1L</span><span class="o">).</span><span class="n">estimate</span>
<span class="c1">// res1: Long = 2
</span>
<span class="n">cms</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="mi">2L</span><span class="o">).</span><span class="n">estimate</span>
<span class="c1">// res2: Long = 0
</span>
<span class="n">cms</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="mi">3L</span><span class="o">).</span><span class="n">estimate</span>
<span class="c1">// res3: Long = 1
</span></code></pre>
</div>

<h2 id="cms-hasher">CMS Hasher</h2>

<p>The Count-Min sketch uses <code class="highlighter-rouge">d</code> (aka <code class="highlighter-rouge">depth</code>) pair-wise independent hash functions drawn from a universal hashing family of the form:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">h</span><span class="o">(</span><span class="n">x</span><span class="o">)</span> <span class="k">=</span> <span class="o">[</span><span class="kt">a</span> <span class="kt">*</span> <span class="kt">x</span> <span class="kt">+</span> <span class="kt">b</span> <span class="o">(</span><span class="kt">mod</span> <span class="kt">p</span><span class="o">)]</span> <span class="o">(</span><span class="n">mod</span> <span class="n">m</span><span class="o">)</span>
</code></pre>
</div>

<p>As a requirement for using <code class="highlighter-rouge">CMS</code> you must provide an implicit <code class="highlighter-rouge">CMSHasher[K]</code> for the type <code class="highlighter-rouge">K</code> of the items you want to count.  Algebird ships with several such implicits for commonly used types <code class="highlighter-rouge">K</code> such as <code class="highlighter-rouge">Long</code> and <code class="highlighter-rouge">scala.BigInt</code>.</p>

<p>If your type <code class="highlighter-rouge">K</code> is not supported out of the box, you have two options:</p>

<ol>
  <li>You provide a “translation” function to convert items of your (unsupported) type <code class="highlighter-rouge">K</code> to a supported type such as <code class="highlighter-rouge">Double</code>, and then use the <code class="highlighter-rouge">contramap</code> function of <code class="highlighter-rouge">CMSHasher</code> to create the required <code class="highlighter-rouge">CMSHasher[K]</code> for your type (see the documentation of <code class="highlighter-rouge">contramap</code> for an example)</li>
  <li>You implement a <code class="highlighter-rouge">CMSHasher[K]</code> from scratch, using the existing <code class="highlighter-rouge">CMSHasher</code> implementations as a starting point.</li>
</ol>

<h1 id="sketch-map">Sketch Map</h1>

<p>A Sketch Map is a generalized version of the Count-Min Sketch that is an approximation of Map[K, V] that stores reference to top heavy hitters. The Sketch Map can approximate the sums of any summable value that has a monoid.</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">val</span> <span class="nc">DELTA</span> <span class="k">=</span> <span class="mi">1</span><span class="n">E</span><span class="o">-</span><span class="mi">8</span>
<span class="c1">// DELTA: Double = 1.0E-8
</span>
<span class="k">val</span> <span class="nc">EPS</span> <span class="k">=</span> <span class="mf">0.001</span>
<span class="c1">// EPS: Double = 0.001
</span>
<span class="k">val</span> <span class="nc">SEED</span> <span class="k">=</span> <span class="mi">1</span>
<span class="c1">// SEED: Int = 1
</span>
<span class="k">val</span> <span class="nc">HEAVY_HITTERS_COUNT</span> <span class="k">=</span> <span class="mi">10</span>
<span class="c1">// HEAVY_HITTERS_COUNT: Int = 10
</span>
<span class="k">implicit</span> <span class="k">def</span> <span class="n">string2Bytes</span><span class="o">(</span><span class="n">i</span> <span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">i</span><span class="o">.</span><span class="n">toCharArray</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toByte</span><span class="o">)</span>
<span class="c1">// string2Bytes: (i: String)Array[Byte]
</span>
<span class="k">val</span> <span class="nc">PARAMS</span> <span class="k">=</span> <span class="nc">SketchMapParams</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">SEED</span><span class="o">,</span> <span class="nc">EPS</span><span class="o">,</span> <span class="nc">DELTA</span><span class="o">,</span> <span class="nc">HEAVY_HITTERS_COUNT</span><span class="o">)</span>
<span class="c1">// PARAMS: com.twitter.algebird.SketchMapParams[String] = SketchMapParams(1,2719,19,10)
</span>
<span class="k">val</span> <span class="nc">MONOID</span> <span class="k">=</span> <span class="nc">SketchMap</span><span class="o">.</span><span class="n">monoid</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Long</span><span class="o">](</span><span class="nc">PARAMS</span><span class="o">)</span>
<span class="c1">// MONOID: com.twitter.algebird.SketchMapMonoid[String,Long] = com.twitter.algebird.SketchMapMonoid@574e5aab
</span>
<span class="k">val</span> <span class="n">data</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span> <span class="o">(</span><span class="s">"1"</span><span class="o">,</span> <span class="mi">1L</span><span class="o">),</span> <span class="o">(</span><span class="s">"3"</span><span class="o">,</span> <span class="mi">2L</span><span class="o">),</span> <span class="o">(</span><span class="s">"4"</span><span class="o">,</span> <span class="mi">1L</span><span class="o">),</span> <span class="o">(</span><span class="s">"5"</span><span class="o">,</span> <span class="mi">1L</span><span class="o">)</span> <span class="o">)</span>
<span class="c1">// data: List[(String, Long)] = List((1,1), (3,2), (4,1), (5,1))
</span>
<span class="k">val</span> <span class="n">sm</span> <span class="k">=</span> <span class="nc">MONOID</span><span class="o">.</span><span class="n">create</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
<span class="c1">// sm: com.twitter.algebird.SketchMap[String,Long] =
// SketchMap(Row: 19, Cols: 2719. Dense elements:
// List((282,1), (763,2), (2172,1), (2523,1))
// List((112,1), (364,2), (923,1), (2433,1))
// List((1615,1), (1652,1), (1794,2), (2357,1))
// List((497,2), (1687,1), (2288,1), (2395,1))
// List((1115,2), (1252,1), (1441,1), (1798,1))
// List((309,1), (556,2), (944,1), (2580,1))
// List((474,1), (570,2), (1073,1), (2271,1))
// List((194,1), (1101,2), (1420,1), (2296,1))
// List((505,1), (1943,1), (1949,1), (2047,2))
// List((1062,1), (1646,1), (1840,1), (2139,2))
// List((549,1), (820,1), (1468,1), (1547,2))
// List((837,2), (1064,1), (1941,1), (2305,1))
// List((338,1), (482,1), (1331,2), (2285,1))
// List((158,1), (1010,2), (1244,1), (1725,1))
// List((90,1), (606,1), (1464,1), (1474,2))
// List((143,1), (768,1), (935,2), (1340,1))
// List(...
</span>
<span class="n">sm</span><span class="o">.</span><span class="n">totalValue</span>
<span class="c1">// res4: Long = 5
</span>
<span class="nc">MONOID</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="n">sm</span><span class="o">,</span> <span class="s">"1"</span><span class="o">)</span>
<span class="c1">// res5: Long = 1
</span>
<span class="nc">MONOID</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="n">sm</span><span class="o">,</span> <span class="s">"2"</span><span class="o">)</span>
<span class="c1">// res6: Long = 0
</span>
<span class="nc">MONOID</span><span class="o">.</span><span class="n">frequency</span><span class="o">(</span><span class="n">sm</span><span class="o">,</span> <span class="s">"3"</span><span class="o">)</span>
<span class="c1">// res7: Long = 2
</span></code></pre>
</div>

<h3 id="documentation-help">Documentation Help</h3>

<p>We’d love your help fleshing out this documentation! You can edit this page in your browser by clicking <a href="https://github.com/twitter/algebird/edit/develop/docs/src/main/tut/datatypes/approx/countminsketch.md">this link</a>. These links might be helpful:</p>

<ul>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/CountMinSketch.scala">CountMinSketch.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-test/src/test/scala/com/twitter/algebird/CountMinSketchTest.scala">CountMinSketchTest.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/CMSHasher.scala">CMSHasher.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-core/src/main/scala/com/twitter/algebird/SketchMap.scala">SketchMap.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-test/src/test/scala/com/twitter/algebird/SketchMapTest.scala">SketchMapTest.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-benchmark/src/main/scala/com/twitter/algebird/benchmark/CMSHashingBenchmark.scala">CMSHashingBenchmark.scala</a></li>
  <li><a href="https://github.com/twitter/algebird/blob/develop/algebird-benchmark/src/main/scala/com/twitter/algebird/benchmark/TopCMSBenchmark.scala">TopCMSBenchmark.scala</a></li>
</ul>
</section></div></div></div></div><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/algebird/highlight/highlight.pack.js"></script><script>hljs.configure({
languages:['scala','java','bash']
});
hljs.initHighlighting();
             </script><script src="/algebird/js/main.js"></script></body></html>